<?php
/**
* @Author
* Navaismo
*/

/**
* Class for help
*/
class webrtcphone {

	/*
	* rank (for prioritizing modules)
	*/
	function rank() {

	$rank = 10;
		return $rank;
	}

	/*
	* init
	*/
	function init() {
	}

	/*
	* Adds menu item to nav menu
	*
	* @param $args
	*   Common arguments
	*/
	function navMenu($args) {
		return "<small><small><a href='" . $_SESSION['ARI_ROOT'] . "?m=webrtcphone&f=display'>" . _("My WebPhone") . "</a></small></small>";
	}


	/* Displays stats page
	*
	* @param $args
	*   Common arguments
	*/
	function display($args) {
		//retreive values
		global $db;
		$extension = $_SESSION['ari_user']['extension'];


		$sql="SELECT data FROM sip WHERE id='$extension' AND keyword='secret'";
		$results = $db->getAll($sql,DB_FETCHMODE_ASSOC);
		foreach($results as $row){
			$password=$row['data'];
		}

		$sql2="select data from sipsettings where keyword = 'realm'";
		$results = $db->getAll($sql2,DB_FETCHMODE_ASSOC);
		foreach($results as $row){
			$realm=$row['data'];
		}

		if (!$realm){
			$realm='asterisk';
		}

		$name = $_SESSION['ari_user']['displayname'];
		$myip = $_SERVER['SERVER_ADDR'];
		$sipuri= "sip:".$extension."@".$myip;
		$cid = $name;
		$websocket="ws://".$myip.":10060";




		$html= <<<EOF
		<input type='hidden' id='jrealm' value='{$myip}' > 
		<input type='hidden' id='jusn' value='{$extension}' >
		<input type='hidden' id='jsipuri' value='{$sipuri}' >
		<input type='hidden' id='jcid' value='{$cid}' >
		<input type='hidden' id='jpassword' value='{$password}' >
		<input type='hidden' id='jwebsocket' value='ws://{$myip}:8088/ws' >
		<input type='hidden' id='jip' value='{$myip}' >
		<link href='theme/webrtc.css' rel='stylesheet' type='text/css'>
		<script src='theme/js/SIPml-api.js' type='text/javascript'> </script>
		<script src='theme/js/webrtc.js' type='text/javascript'> </script>
		<h2>Web Phone for {$name}</h2>
		<div id='line'>
			<div class='spacer'></div>
			<div class='spacer'></div>
		</div>
		<div>
			<ul>
				<li>This Phone is a temporal replacement for your normal phone.</li>
				<li>You can call as usual, it support DTFM on call as well.</li>
				<li>Can't Transfer using the phone but using features codes.(yet).</li>
				<li>Can't put On Hold a call.(yet).</li>
			</ul>
		</div>
		<br>
		<!--/****************************** html/php code *************************************/-->
		<!-- some ugly space -->

		<!-- trying to create beatiful boxes  failed! :( -->
		<div id='sysinfo-left' class='infobox ui-widget-content  ui-corner-all' >
			<h3 class='ui-widget-header ui-state-default ui-corner-all'>WebSoftphone</h3>
			<div align=center id='mysipstatus' style='font-size: 10px'></div>	
			<table style='width: 100%;'>
				<tr>
					<td>
						<div align='center'>
							<input autofocus type='text' style='width: 80%' value='' id='callnumber' /> 
							<br>
						</div>
					</td> 
				</tr>
				<tr>			
					<td colspan='1' align='center'>
						<!-- KeyPad Div -->
						<table >
							<tr><td><input type='button' style='width: 32%' class='btn-primary' value='1' onclick='sipSendDTMF(1);'/><input type='button' style='width: 32%' class='btn-primary' value='2' onclick='sipSendDTMF(2);'/><input type='button' style='width: 32%' class='btn-primary' value='3' onclick='sipSendDTMF(3);'/></td></tr>
							<tr><td><input type='button' style='width: 32%' class='btn-primary' value='4' onclick='sipSendDTMF(4);'/><input type='button' style='width: 32%' class='btn-primary' value='5' onclick='sipSendDTMF(5);'/><input type='button' style='width: 32%' class='btn-primary' value='6' onclick='sipSendDTMF(6);'/></td></tr>
							<tr><td><input type='button' style='width: 32%' class='btn-primary' value='7' onclick='sipSendDTMF(7);'/><input type='button' style='width: 32%' class='btn-primary' value='8' onclick='sipSendDTMF(8);'/><input type='button' style='width: 32%' class='btn-primary' value='9' onclick='sipSendDTMF(9);'/></td></tr>
							<tr><td><input type='button' style='width: 32%' class='btn-primary' value='*' onclick=sipSendDTMF('*'); /><input type='button' style='width: 32%' class='btn-primary' value='0' onclick=sipSendDTMF('0'); /><input type='button' style='width: 32%' class='btn-primary' value='#' onclick=sipSendDTMF('#'); /></td></tr>
						</table>
						<input type='button' class='btn-success' style='width:25%' id='btnCall' value='Call' onclick='call();' />&nbsp;
						<input type='button' class='btn-danger' style='width:25%'  id='btnHangUp' value='HangUp' onclick='hangup();' />
					</td>
				<tr>
				</tr>			
				<tr>
					<td>
						<div align=center id='mycallstatus' style='font-size: 10px'></div>
					</td>
				</tr>
			</table>
		</div>

		<!-- Audios -->
		<audio id='audio_remote' autoplay='autoplay' />
		<audio id='ringtone' loop src='modules/websoftphone/sounds/ringtone.wav' />
		<audio id='ringbacktone' loop src='modules/websoftphone/sounds/ringbacktone.wav' />
		<audio id='dtmfTone' src='modules/websoftphone/sounds/dtmf.wav' />
		<audio id='newmsg' src='modules/websoftphone/sounds/newmsg.wav' />
EOF;

		return $html;
	}
}